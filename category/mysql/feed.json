{
    "version": "https://jsonfeed.org/version/1",
    "title": "A Blog • All posts by \"mysql\" category",
    "description": "Just another blog.",
    "home_page_url": "https://blog.timerever.tk",
    "items": [
        {
            "id": "https://blog.timerever.tk/2022/02/28/mysql-federated-storage-engine-tutorials/",
            "url": "https://blog.timerever.tk/2022/02/28/mysql-federated-storage-engine-tutorials/",
            "title": "MySQL FEDERATED 存储引擎介绍及使用",
            "date_published": "2022-02-28T06:55:51.000Z",
            "content_html": "<p>项目上遇到了一个需求，需要在 MySQL（不同实例）进行跨库 join 操作。我们都知道如果是同一实例，那么 MySQL 跨库查询肯定是没有问题的，但是不同实例的跨库查询之前一直没有做过。不过以前还在用 Oracle 的时候，Oracle 有个功能叫做 DATABASE LINK（参见 <a href=\"https://docs.oracle.com/cd/B19306_01/server.102/b14200/statements_5005.htm\">CREATE DATABASE LINK</a>），是将远程数据库映射到本地，这样就可以在一个实例中访问其他数据库了。在谷歌搜索 MySQL 跨库查询的时候，发现 MySQL 也有类似的东西，叫做 FEDERATED 存储引擎。所以我们就可以使用 FEDERATED 将需要 join 的远端表映射到本地数据库，这样在做查询的时候使用上就跟本地表一样了。</p>\n<p>官方文档：<a href=\"https://dev.mysql.com/doc/refman/8.0/en/federated-storage-engine.html\">The FEDERATED Storage Engine</a></p>\n<span id=\"more\"></span>\n<h3 id=\"federated-表介绍\"><a class=\"markdownIt-Anchor\" href=\"#federated-表介绍\"></a> FEDERATED 表介绍</h3>\n<p>FEDERATED 表在使用上与普通表没有区别，不过 FEDERATED 表只会在本地存储表结构定义而不会直接存储数据，所以在每次查询时数据均需要从远端获取。<br />\nFEDERATED 表支持 DML 语句，DDL 语句只支持 <code>DROP TABLE</code>，效果为删除本地的 FEDERATED 表。</p>\n<p>官方架构如下：</p>\n<img src=\"/2022/02/28/mysql-federated-storage-engine-tutorials/mysql-federated-storage-engine-tutorials-1.png\" class=\"\" title=\"FEDERATED 架构\">\n<h3 id=\"准备工作\"><a class=\"markdownIt-Anchor\" href=\"#准备工作\"></a> 准备工作</h3>\n<p>在使用 FEDERATED 表前，需要先看一下是否满足条件：</p>\n<ul>\n<li>创建 FEDERATED 表的 MySQL 实例需要支持 FEDERATED 引擎，如果是安装的二进制包则没有问题，如果是从源码编译，需要在编译时加上 <code>-DWITH_FEDERATED_STORAGE_ENGINE</code> 参数</li>\n<li>创建 FEDERATED 表的 MySQL 实例需要打开 FEDERATED 引擎支持，MySQL 默认没有打开，需要在启动时追加 <code>--federated</code> 命令，或是在配置文件的 <code>[mysqld]</code> 小节添加 <code>federated</code> 并重启服务器。可以在 MySQL 中执行 <code>SHOW ENGINES</code> 语句来查询支持状态</li>\n<li>FEDERATED 表支持的远端数据库只能为 MySQL，同时支持 <code>MyISAM</code> 和 <code>InnoDB</code> 存储引擎</li>\n<li>经测试，5.7 版本的数据库连接 8.0 版本会报 SSL 错误，所以建议使用 8.0 版本</li>\n</ul>\n<h3 id=\"创建-federated-表\"><a class=\"markdownIt-Anchor\" href=\"#创建-federated-表\"></a> 创建 FEDERATED 表</h3>\n<p>创建 FEDERATED 表有两种方式，但是大同小异，区别只是远端数据库连接是存储在表定义中还是存储到单独的位置。因为 FEDERATED 是表维度，所以为了复用远端连接，建议采用 <code>CREATE SERVER</code> 的方式创建 FEDERATED表。</p>\n<h4 id=\"使用-create-server-的方式创建-federated-表\"><a class=\"markdownIt-Anchor\" href=\"#使用-create-server-的方式创建-federated-表\"></a> 使用 CREATE SERVER 的方式创建 FEDERATED 表</h4>\n<p>首先我们需要先创建远端数据库连接，创建远端连接的格式为：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> SERVER</span><br><span class=\"line\">server_name</span><br><span class=\"line\"><span class=\"keyword\">FOREIGN</span> DATA WRAPPER wrapper_name</span><br><span class=\"line\">OPTIONS (option [, option] ...)</span><br></pre></td></tr></table></figure>\n<p>例如：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> SERVER fedlink</span><br><span class=\"line\"><span class=\"keyword\">FOREIGN</span> DATA WRAPPER mysql</span><br><span class=\"line\">OPTIONS (<span class=\"keyword\">USER</span> <span class=\"string\">&#x27;fed_user&#x27;</span>, PASSWORD <span class=\"string\">&#x27;password&#x27;</span>, HOST <span class=\"string\">&#x27;remote_host&#x27;</span>, PORT <span class=\"number\">9306</span>, DATABASE <span class=\"string\">&#x27;federated&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p>我们需要记住输入的 <code>server_name</code> 即 fedlink，然后我们需要拿到要创建的源表的表结构，可以使用 <code>SHOW CREATE TABLE table_name</code> 来打印，然后将 <code>ENGINE</code> 改为 FEDERATED，添加 <code>CONNECTION='fedlink/table_name'</code>，执行后即在本地生成了 FEDERATED 表。例如：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> test_table (</span><br><span class=\"line\">    id     <span class=\"type\">INT</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> AUTO_INCREMENT,</span><br><span class=\"line\">    name   <span class=\"type\">VARCHAR</span>(<span class=\"number\">32</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">    other  <span class=\"type\">INT</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"string\">&#x27;0&#x27;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">PRIMARY</span> KEY  (id),</span><br><span class=\"line\">    INDEX name (name),</span><br><span class=\"line\">    INDEX other_key (other)</span><br><span class=\"line\">)</span><br><span class=\"line\">ENGINE<span class=\"operator\">=</span>FEDERATED</span><br><span class=\"line\"><span class=\"keyword\">DEFAULT</span> CHARSET<span class=\"operator\">=</span>utf8mb4</span><br><span class=\"line\">CONNECTION<span class=\"operator\">=</span><span class=\"string\">&#x27;fedlink/test_table&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p>这里创建的表名即 <code>CREATE TABLE</code> 后面的表名可以与源表不一样，只需在 <code>CONNECTION</code> 中指定源表名即可。</p>\n<h4 id=\"使用-connection-的方式创建-federated-表\"><a class=\"markdownIt-Anchor\" href=\"#使用-connection-的方式创建-federated-表\"></a> 使用 CONNECTION 的方式创建 FEDERATED 表</h4>\n<p>如果没有 <code>CREATE SERVER</code> 权限，也可以直接使用 CONNECTION 的方式创建 FEDERATED 表，只需将上面建表语句中 <code>CONNECTION</code> 的值改为完整连接即可，例如：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> federated_table (</span><br><span class=\"line\">    id     <span class=\"type\">INT</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> AUTO_INCREMENT,</span><br><span class=\"line\">    name   <span class=\"type\">VARCHAR</span>(<span class=\"number\">32</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">    other  <span class=\"type\">INT</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"keyword\">NULL</span> <span class=\"keyword\">DEFAULT</span> <span class=\"string\">&#x27;0&#x27;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">PRIMARY</span> KEY  (id),</span><br><span class=\"line\">    INDEX name (name),</span><br><span class=\"line\">    INDEX other_key (other)</span><br><span class=\"line\">)</span><br><span class=\"line\">ENGINE<span class=\"operator\">=</span>FEDERATED</span><br><span class=\"line\"><span class=\"keyword\">DEFAULT</span> CHARSET<span class=\"operator\">=</span>utf8mb4</span><br><span class=\"line\">CONNECTION<span class=\"operator\">=</span><span class=\"string\">&#x27;mysql://fed_user@remote_host:9306/federated/test_table&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p><strong>需要注意的是：</strong></p>\n<ul>\n<li>采用这种方式创建的 FEDERATED 表，可以通过 <code>SHOW CREATE TABLE</code> 看到原始的连接信息</li>\n<li>如果密码中包含 <code>@</code>，由于 <code>@</code> 需要作为 url 的分界符，所以这种情况下只能使用 <code>CREATE SERVER</code> 的方式创建 FEDERATED 表</li>\n</ul>\n",
            "tags": [
                "MySQL",
                "Tutorial"
            ]
        }
    ]
}