{
    "version": "https://jsonfeed.org/version/1",
    "title": "A Blog • All posts by \"c\" tag",
    "description": "Just another blog.",
    "home_page_url": "https://blog.timerever.tk",
    "items": [
        {
            "id": "https://blog.timerever.tk/2017/04/26/undefined-reference-to-pthread_create/",
            "url": "https://blog.timerever.tk/2017/04/26/undefined-reference-to-pthread_create/",
            "title": "对 “pthread_create” 未定义的引用",
            "date_published": "2017-04-26T15:01:27.000Z",
            "content_html": "<p>今天在对 Linux 多线程编程进行学习时，在编译代码时出现了问题。</p>\n<p>由于使用了 <code>pthread_create</code>, <code>pthread_join</code> 等函数，在使用 <code>gcc</code> 编译时，出现了 <strong>对 ‘pthread_create’ 未定义的引用</strong> 的错误，在上网查询后，得知 pthread 库不是 Linux 系统默认的库，所以在编译时需要添加 <code>-lpthread</code> 参数来使用 libpthread.a 库进行编译。</p>\n<pre><code># gcc -o pthread -lpthread pthread.c\n</code></pre>\n<p>结果还是失败。再次上网查阅，得知 <code>-lpthread</code> 应该放到最后面，修改后编译通过。</p>\n<pre><code># gcc thread.c -o thread.c -lpthread\n</code></pre>\n<p><strong>参考链接：<a href=\"http://blog.csdn.net/besfanfei/article/details/7542396\">http://blog.csdn.net/besfanfei/article/details/7542396</a></strong></p>\n",
            "tags": [
                "Linux",
                "C"
            ]
        },
        {
            "id": "https://blog.timerever.tk/2017/04/24/fix-sigaction/",
            "url": "https://blog.timerever.tk/2017/04/24/fix-sigaction/",
            "title": "sigaction 自定义信号处理函数的“修复”",
            "date_published": "2017-04-24T11:15:05.000Z",
            "content_html": "<p>在对嵌入式 Linux 系统程序开发中的进程间通信进行学习时，涉及到了信号集函数组，书中给出的示例如下：</p>\n<blockquote>\n<p>该实例首先把 SIGQUIT、SIGINT 两个信号加入信号集，然后将该信号集设为阻塞状态，<br>并在该状态下使程序暂停 5 秒。接下来再将信号集设置为非阻塞状态，再对这两个信号分别<br>操作，其中 SIGQUIT 执行默认操作，而 SIGINT 执行用户自定义函数的操作。源代码如下<br>所示：</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">my_func</span><span class=\"params\">(<span class=\"keyword\">int</span> signum)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;If you want to quit,please try SIGQUIT\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">sigset_t</span> <span class=\"built_in\">set</span>,pendset;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> <span class=\"title\">action1</span>,<span class=\"title\">action2</span>;</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sigemptyset(&amp;<span class=\"built_in\">set</span>)&lt;<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;sigemptyset&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sigaddset(&amp;<span class=\"built_in\">set</span>,SIGQUIT)&lt;<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;sigaddset&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sigaddset(&amp;<span class=\"built_in\">set</span>,SIGINT)&lt;<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;sigaddset&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sigprocmask(SIG_BLOCK,&amp;<span class=\"built_in\">set</span>,<span class=\"literal\">NULL</span>)&lt;<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;sigprocmask&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;blocked\\n&quot;</span>);</span><br><span class=\"line\">\t\tsleep(<span class=\"number\">5</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sigprocmask(SIG_UNBLOCK,&amp;<span class=\"built_in\">set</span>,<span class=\"literal\">NULL</span>)&lt;<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;sigprocmask&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;unblock\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(sigismember(&amp;<span class=\"built_in\">set</span>,SIGINT))&#123;</span><br><span class=\"line\">\t\t\tsigemptyset(&amp;action1.sa_mask);</span><br><span class=\"line\">\t\t\taction1.sa_handler=my_func;</span><br><span class=\"line\">\t\t\tsigaction(SIGINT,&amp;action1,<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(sigismember(&amp;<span class=\"built_in\">set</span>,SIGQUIT))&#123;</span><br><span class=\"line\">\t\t\tsigemptyset(&amp;action2.sa_mask);</span><br><span class=\"line\">\t\t\taction2.sa_handler = SIG_DFL;</span><br><span class=\"line\">\t\t\tsigaction(SIGTERM,&amp;action2,<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>理论上，按说明所述及代码的编写，使用 <code>Ctrl-C</code> 传递 <code>SIGINT</code> 信号后，会转到自定义处理函数 <code>my_func</code>，但在实际操作中，在进入自定义处理函数后，程序直接退出。<strong>猜测</strong>是由于在进行自定义处理函数后，系统仍然对信号做了默认的处理。</p>\n<p>在请教老师后，给出了一种解决方案，对 <code>sigaction</code> 结构体中的 <code>sa_flags</code> 进行赋值，这里先贴出该结构体。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">void</span> (*sa_handler)(<span class=\"keyword\">int</span> signo);</span><br><span class=\"line\">\t<span class=\"keyword\">sigset_t</span> sa_mask;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> sa_flags;</span><br><span class=\"line\">\t<span class=\"keyword\">void</span> (*sa_restore)(<span class=\"keyword\">void</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sa_handler</code> 是一个函数指针，指定信号关联函数，这里除可以是用户自定义的处理函数<br>外，还可以为 <code>SIG_DFL</code>（采用缺省的处理方式）或 <code>SIG_IGN</code>（忽略信号）。它的处理函数只<br>有一个参数，即信号值。<br><code>sa_mask</code> 是一个信号集，它可以指定在信号处理程序执行过程中哪些信号应当被阻塞，<br>在调用信号捕获函数之前，该信号集要加入到信号的信号屏蔽字中。<br><code>sa_flags</code> 中包含了许多标志位，是对信号进行处理的各个选择项。它的常见可选值如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">选项</th>\n<th align=\"left\">含义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">SA_NODEFER&#x2F;SA_NOMASK</td>\n<td align=\"left\">当捕捉到此信号时，在执行其信号捕捉函数时，系统不会自动阻塞此信号</td>\n</tr>\n<tr>\n<td align=\"left\">SA_NOCLDSTOP</td>\n<td align=\"left\">进程忽略子进程产生的任何 SIGSTOP、SIGTSTP、SIGTTIN 和 SIGTTOU 信号</td>\n</tr>\n<tr>\n<td align=\"left\">SA_RESTART</td>\n<td align=\"left\">可让重启的系统调用重新起作用</td>\n</tr>\n<tr>\n<td align=\"left\">SA_ONESHOT&#x2F;SA_RESETHAND</td>\n<td align=\"left\">自定义信号只执行一次，在执行完毕后恢复信号的系统默认动作</td>\n</tr>\n</tbody></table>\n<p>将 <code>sigaction</code> 结构体中的 <code>sa_flags</code> 成员赋值为 0，修改后的部分代码如下。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span>(<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sigismember(&amp;<span class=\"built_in\">set</span>,SIGINT))&#123;</span><br><span class=\"line\">\t\tsigemptyset(&amp;action1.sa_mask);</span><br><span class=\"line\">\t\taction1.sa_handler=my_func;</span><br><span class=\"line\">\t\taction1.sa_flags=<span class=\"number\">0</span>; <span class=\"comment\">//添加此行</span></span><br><span class=\"line\">\t\tsigaction(SIGINT,&amp;action1,<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(sigismember(&amp;<span class=\"built_in\">set</span>,SIGQUIT))&#123;</span><br><span class=\"line\">\t\tsigemptyset(&amp;action2.sa_mask);</span><br><span class=\"line\">\t\taction2.sa_handler = SIG_DFL;</span><br><span class=\"line\">\t\tsigaction(SIGTERM,&amp;action2,<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这样修改后，程序确实正常运行了。但是根据该书所述和在网上查询，始终未能理解为何这样操作，而且之后尝试赋其他值，依然正常运行。网上国内的氛围就是博客间互相复制互相抄袭，找不到多少主观的分析，所以一直未能解决，仅在此做下记录。</p>\n",
            "tags": [
                "Linux",
                "C"
            ]
        }
    ]
}