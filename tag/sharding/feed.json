{
    "version": "https://jsonfeed.org/version/1",
    "title": "A Blog • All posts by \"sharding\" tag",
    "description": "Just another blog.",
    "home_page_url": "https://blog.timerever.tk",
    "items": [
        {
            "id": "https://blog.timerever.tk/2022/03/01/resolve-class-not-found-in-sharding-jdbc/",
            "url": "https://blog.timerever.tk/2022/03/01/resolve-class-not-found-in-sharding-jdbc/",
            "title": "修复 Sharding-JDBC 使用时的两次 NoClassDefFoundError",
            "date_published": "2022-03-01T06:38:32.000Z",
            "content_html": "<p>由于项目上有着某些需求，所以需要使用 Sharding-JDBC。根据官方文档，引入 <code>shardingsphere-jdbc-core</code> 依赖并使用当前最新版本 5.1.0，结果在测试的过程中出现了两次 NoClassDefFoundError，分别记录一下解决过程。</p>\n<span id=\"more\"></span>\n<h3 id=\"一-classnotfoundexception-orgapachetomcatdbcpdbcp2basicdatasource\"><a class=\"markdownIt-Anchor\" href=\"#一-classnotfoundexception-orgapachetomcatdbcpdbcp2basicdatasource\"></a> 一、ClassNotFoundException: org.apache.tomcat.dbcp.dbcp2.BasicDataSource</h3>\n<p>配置完程序，兴冲冲地打开前端准备测试，可没想到刚打开就报了个错。老规矩，先看最后一个 Caused by，结果是个没头没脑的 ClassNotFoundException。</p>\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-1.png\" class=\"\" title=\"报错信息\">\n<p>那就继续往上翻，看一下异常栈信息。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Caused by: java.lang.NoClassDefFoundError: org/apache/tomcat/dbcp/dbcp2/BasicDataSource</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.datasource.pool.metadata.type.dbcp.TomcatDBCPDataSourcePoolMetaData.getType(TomcatDBCPDataSourcePoolMetaData.java:67)</span><br><span class=\"line\">\tat org.apache.shardingsphere.spi.typed.TypedSPIRegistry.lambda$findRegisteredService$0(TypedSPIRegistry.java:44)</span><br><span class=\"line\">\tat java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:174)</span><br><span class=\"line\">\tat java.util.ArrayList$ArrayListSpliterator.tryAdvance(ArrayList.java:1361)</span><br><span class=\"line\">\tat java.util.stream.ReferencePipeline.forEachWithCancel(ReferencePipeline.java:126)</span><br><span class=\"line\">\tat java.util.stream.AbstractPipeline.copyIntoWithCancel(AbstractPipeline.java:499)</span><br><span class=\"line\">\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:486)</span><br><span class=\"line\">\tat java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)</span><br><span class=\"line\">\tat java.util.stream.FindOps$FindOp.evaluateSequential(FindOps.java:152)</span><br><span class=\"line\">\tat java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)</span><br><span class=\"line\">\tat java.util.stream.ReferencePipeline.findFirst(ReferencePipeline.java:531)</span><br><span class=\"line\">\tat org.apache.shardingsphere.spi.typed.TypedSPIRegistry.findRegisteredService(TypedSPIRegistry.java:44)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.datasource.pool.metadata.DataSourcePoolMetaDataFactory.newInstance(DataSourcePoolMetaDataFactory.java:46)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.datasource.props.DataSourcePropertiesCreator.createProperties(DataSourcePropertiesCreator.java:81)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.datasource.props.DataSourcePropertiesCreator.create(DataSourcePropertiesCreator.java:57)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.metadata.resource.DataSourcesMetaData.&lt;init&gt;(DataSourcesMetaData.java:41)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.metadata.ShardingSphereMetaData.createResource(ShardingSphereMetaData.java:73)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.metadata.ShardingSphereMetaData.create(ShardingSphereMetaData.java:66)</span><br><span class=\"line\">\tat org.apache.shardingsphere.mode.metadata.MetaDataContextsBuilder.getMetaDataMap(MetaDataContextsBuilder.java:105)</span><br><span class=\"line\">\tat org.apache.shardingsphere.mode.metadata.MetaDataContextsBuilder.build(MetaDataContextsBuilder.java:96)</span><br><span class=\"line\">\tat org.apache.shardingsphere.mode.manager.memory.MemoryContextManagerBuilder.build(MemoryContextManagerBuilder.java:49)</span><br><span class=\"line\">\tat org.apache.shardingsphere.driver.jdbc.core.datasource.ShardingSphereDataSource.createContextManager(ShardingSphereDataSource.java:81)</span><br><span class=\"line\">\tat org.apache.shardingsphere.driver.jdbc.core.datasource.ShardingSphereDataSource.&lt;init&gt;(ShardingSphereDataSource.java:64)</span><br><span class=\"line\">\tat org.apache.shardingsphere.driver.api.ShardingSphereDataSourceFactory.createDataSource(ShardingSphereDataSourceFactory.java:77)</span><br></pre></td></tr></table></figure>\n<p>首先点进去看一下第一行的 <code>TomcatDBCPDataSourcePoolMetaData</code> 这个类，IDE 很明显地提示了错误，所以根源在于 Sharding 使用了 <code>BasicDataSource</code> 类却没有引入其依赖。</p>\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-2.png\" class=\"\" title=\"IDE 报红\">\n<p>既然问题的根源找到了，那么接下来看一眼为什么会触发到这里。</p>\n<p>接着看第二行，<code>TypedSPIRegistry</code> 类的 44 行，并在这里下一个断点：</p>\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-3.png\" class=\"\" title=\"打下断点\">\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-4.png\" class=\"\" title=\"断点暂停\">\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-5.png\" class=\"\" title=\"运行表达式\">\n<p>可以看到，<code>ShardingSphereServiceLoader.newServiceInstances(typedSPIClass)</code> 方法传入了 SPI 类 <code>DataSourcePoolMetaData</code>， 并获取到了其三个实现类，而最后一个 <code>TomcatDBCPDataSourcePoolMetaData</code> 类就是刚才抛出异常的类。</p>\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-6.png\" class=\"\" title=\"DataSourcePoolMetaData 实现类\">\n<p>然后在后续的 <code>filter</code> 中，会循环每个对象，在调用 <code>getType()</code> 方法时便出现了异常。</p>\n<p>所以看上去并不是自己的问题，在谷歌之后发现，近期已经有人提出了这个问题，具体可以参见：<a href=\"https://github.com/apache/shardingsphere/issues/15507\">Add example that implements the Metadata SPI for third-party JDBC pools</a>。</p>\n<p>通过 issue 中的描述我们可以得知，这个问题是在 5.1.0 中才出现的。看上去已经有人提了 PR 修复了这个问题，但是目前还没有发布新版本。所以我们可以降级到 5.0.0 使用旧版本来规避这个问题，或者直接引入缺失的依赖使代码不再报错。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.tomcat<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>tomcat-dbcp<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>10.0.16<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"二-noclassdeffounderror-organtlrv4runtimecodepointbuffer\"><a class=\"markdownIt-Anchor\" href=\"#二-noclassdeffounderror-organtlrv4runtimecodepointbuffer\"></a> 二、NoClassDefFoundError: org/antlr/v4/runtime/CodePointBuffer</h3>\n<p>修复好刚才的问题之后，重新运行程序，创建数据源，好，没有报错。再执行一下 SQL 查询，不好，又报错了…</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Caused by: java.lang.NoClassDefFoundError: org/antlr/v4/runtime/CodePointBuffer</span><br><span class=\"line\">\tat org.apache.shardingsphere.sql.parser.core.SQLParserFactory.getSQLCharStream(SQLParserFactory.java:82)</span><br><span class=\"line\">\tat org.apache.shardingsphere.sql.parser.core.SQLParserFactory.createTokenStream(SQLParserFactory.java:76)</span><br><span class=\"line\">\tat org.apache.shardingsphere.sql.parser.core.SQLParserFactory.newInstance(SQLParserFactory.java:55)</span><br><span class=\"line\">\tat org.apache.shardingsphere.sql.parser.core.database.parser.SQLParserExecutor.twoPhaseParse(SQLParserExecutor.java:58)</span><br><span class=\"line\">\tat org.apache.shardingsphere.sql.parser.core.database.parser.SQLParserExecutor.parse(SQLParserExecutor.java:49)</span><br><span class=\"line\">\tat org.apache.shardingsphere.sql.parser.api.SQLParserEngine.parse(SQLParserEngine.java:47)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.parser.sql.SQLStatementParserExecutor.parse(SQLStatementParserExecutor.java:48)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.parser.sql.SQLStatementParserEngine.parse(SQLStatementParserEngine.java:47)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.parser.ShardingSphereSQLParserEngine.parse0(ShardingSphereSQLParserEngine.java:70)</span><br><span class=\"line\">\tat org.apache.shardingsphere.infra.parser.ShardingSphereSQLParserEngine.parse(ShardingSphereSQLParserEngine.java:59)</span><br><span class=\"line\">\tat org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSphereStatement.createLogicSQL(ShardingSphereStatement.java:414)</span><br><span class=\"line\">\tat org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSphereStatement.executeQuery(ShardingSphereStatement.java:144)</span><br><span class=\"line\">\tat org.springframework.jdbc.core.JdbcTemplate$1QueryStatementCallback.doInStatement(JdbcTemplate.java:452)</span><br><span class=\"line\">\tat org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:381)</span><br><span class=\"line\">\tat org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:465)</span><br><span class=\"line\">\tat org.springframework.jdbc.core.JdbcTemplate.queryForRowSet(JdbcTemplate.java:530)</span><br></pre></td></tr></table></figure>\n<p>从第一行点进去先看眼，又是找不到类，不过这次不太一样。看下上面的 import，发现这个包下的大部分的类都可以找到，只有这两个没有找到：</p>\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-7.png\" class=\"\" title=\"import 信息\">\n<p>只能盲猜是版本问题，打开 Maven Helper 看一下依赖情况，果然是和公司自己的包发生了版本冲突。手动指定版本到 4.9.2，问题解决。</p>\n<img src=\"/2022/03/01/resolve-class-not-found-in-sharding-jdbc/resolve-class-not-found-in-sharding-jdbc-8.png\" class=\"\" title=\"import 信息\">\n",
            "tags": [
                "Java",
                "Sharding",
                "Sharding-JDBC"
            ]
        }
    ]
}